import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Book, Activity, AlertTriangle, ArrowLeft, Info, Thermometer, RotateCcw, CheckCircle, XCircle, Trophy, Home, Play } from 'lucide-react';

const App = () => {
  const [currentView, setCurrentView] = useState('home'); // home, quiz, nines, classification

  const renderView = () => {
    switch (currentView) {
      case 'home':
        return <HomeView setView={setCurrentView} />;
      case 'nines':
        return <RuleOfNinesView setView={setCurrentView} />;
      case 'classification':
        return <ClassificationView setView={setCurrentView} />;
      case 'quiz':
        return <QuizView setView={setCurrentView} />;
      default:
        return <HomeView setView={setCurrentView} />;
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      <div className="max-w-md mx-auto h-[100dvh] flex flex-col bg-white shadow-2xl overflow-hidden relative">
        {renderView()}
      </div>
    </div>
  );
};

// --- Shared Constants & Helpers ---
const initialPartsData = [
    { id: 'head', name: '頭部', percent: 9, status: 0 },
    { id: 'torso_f', name: '軀幹(前)', percent: 18, status: 0 },
    { id: 'back_torso', name: '軀幹(後)', percent: 18, status: 0 },
    { id: 'arm_l', name: '左手', percent: 9, status: 0 },
    { id: 'arm_r', name: '右手', percent: 9, status: 0 },
    { id: 'leg_l', name: '左腿', percent: 18, status: 0 },
    { id: 'leg_r', name: '右腿', percent: 18, status: 0 },
    { id: 'groin', name: '會陰', percent: 1, status: 0 },
];

const getColorFill = (status) => {
    switch (status) {
    case 1: return '#facc15'; // yellow-400
    case 2: return '#f97316'; // orange-500
    case 3: return '#dc2626'; // red-600
    default: return '#e2e8f0'; // slate-200
  }
}

// --- Home View ---
const HomeView = ({ setView }) => (
  <div className="flex flex-col items-center justify-center h-full p-6 bg-gradient-to-b from-blue-50 to-white">
    <div className="mb-10 text-center">
      <div className="bg-red-100 p-4 rounded-full inline-block mb-4 shadow-sm">
        <Activity size={48} className="text-red-500" />
      </div>
      <h1 className="text-3xl font-bold text-slate-800 tracking-tight">燒燙傷急救助手</h1>
      <p className="text-slate-500 mt-2">專業評估與知識學習工具</p>
    </div>

    <div className="w-full space-y-4">
      <MenuButton 
        onClick={() => setView('quiz')} 
        icon={<Book size={24} />} 
        title="隨堂測驗" 
        subtitle="挑戰您的評估能力 (10題)" 
        color="bg-blue-500"
        delay="0"
      />
      <MenuButton 
        onClick={() => setView('nines')} 
        icon={<Activity size={24} />} 
        title="燒燙傷九分法" 
        subtitle="互動式體表面積計算" 
        color="bg-red-500"
        delay="100"
      />
      <MenuButton 
        onClick={() => setView('classification')} 
        icon={<AlertTriangle size={24} />} 
        title="燒燙傷分級" 
        subtitle="深度判斷與定義" 
        color="bg-orange-500"
        delay="200"
      />
    </div>
    
    <div className="mt-auto pb-6 text-xs text-slate-400">
      Designed for First Aid Education
    </div>
  </div>
);

const MenuButton = ({ onClick, icon, title, subtitle, color, delay }) => (
  <button 
    onClick={onClick}
    className="w-full flex items-center p-4 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md transition-all active:scale-95 duration-200 group"
    style={{ animation: `fadeInUp 0.5s ease-out ${delay}ms both` }}
  >
    <div className={`${color} text-white p-3 rounded-xl shadow-md group-hover:shadow-lg transition-shadow`}>
      {icon}
    </div>
    <div className="ml-4 text-left">
      <div className="font-bold text-lg text-slate-800">{title}</div>
      <div className="text-sm text-slate-500">{subtitle}</div>
    </div>
  </button>
);

// --- Body Diagram Component (Reusable) ---
const BodyDiagram = ({ parts, onPartClick, readOnly = false }) => {
    const getStatus = (id) => parts.find(p => p.id === id)?.status || 0;
    const getFill = (id) => getColorFill(getStatus(id));

    // Click handler logic
    const clk = (id) => readOnly ? {} : { 
        onClick: () => onPartClick(id), 
        className: "cursor-pointer transition-colors duration-200 hover:opacity-90" 
    };

    return (
      <div className="w-full h-full flex items-center justify-center pt-2 pb-0 px-2 relative">
        <svg viewBox="0 0 200 125" className="max-h-full w-full select-none">
          <g stroke="white" strokeWidth="0.8">
            <line x1="100" y1="12" x2="100" y2="120" stroke="#cbd5e1" strokeWidth="1" strokeDasharray="4 2" />

            {/* FRONT */}
            <g transform="translate(0, 0)">
                <rect x="25" y="0" width="50" height="12" rx="4" fill="#334155" />
                <text x="50" y="8" textAnchor="middle" fontSize="7" fill="white" fontWeight="bold" dominantBaseline="middle" style={{fontFamily: 'sans-serif'}}>正面</text>
                
                <g transform="translate(0, 10)">
                    <circle cx="50" cy="20" r="7" fill={getFill('head')} {...clk('head')} />
                    <path d="M42 29 L58 29 L58 61 L42 61 Z" fill={getFill('torso_f')} {...clk('torso_f')} />
                    <path d="M42 61 L58 61 L50 72 Z" fill={getFill('groin')} {...clk('groin')} />
                    <rect x="18" y="29" width="22" height="7" rx="2" fill={getFill('arm_r')} {...clk('arm_r')} transform="rotate(70 29 32.5)" />
                    <rect x="60" y="29" width="22" height="7" rx="2" fill={getFill('arm_l')} {...clk('arm_l')} transform="rotate(110 71 32.5)" />
                    <rect x="30" y="68" width="16" height="42" rx="3" fill={getFill('leg_r')} {...clk('leg_r')} />
                    <rect x="54" y="68" width="16" height="42" rx="3" fill={getFill('leg_l')} {...clk('leg_l')} />
                </g>
            </g>

            {/* BACK */}
            <g transform="translate(100, 0)">
                <rect x="25" y="0" width="50" height="12" rx="4" fill="#64748b" />
                <text x="50" y="8" textAnchor="middle" fontSize="7" fill="white" fontWeight="bold" dominantBaseline="middle" style={{fontFamily: 'sans-serif'}}>背面</text>

                <g transform="translate(0, 10)">
                    <circle cx="50" cy="20" r="7" fill={getFill('head')} {...clk('head')} />
                    <path d="M42 29 L58 29 L58 68 L42 68 Z" fill={getFill('back_torso')} {...clk('back_torso')} />
                    <rect x="18" y="29" width="22" height="7" rx="2" fill={getFill('arm_l')} {...clk('arm_l')} transform="rotate(70 29 32.5)" />
                    <rect x="60" y="29" width="22" height="7" rx="2" fill={getFill('arm_r')} {...clk('arm_r')} transform="rotate(110 71 32.5)" />
                    <rect x="30" y="68" width="16" height="42" rx="3" fill={getFill('leg_l')} {...clk('leg_l')} />
                    <rect x="54" y="68" width="16" height="42" rx="3" fill={getFill('leg_r')} {...clk('leg_r')} />
                </g>
            </g>
          </g>
        </svg>
      </div>
    );
};

// --- Quiz View ---
const QuizView = ({ setView }) => {
    const TOTAL_QUESTIONS = 10;
    const [gameState, setGameState] = useState('intro'); // intro, playing, result
    const [questions, setQuestions] = useState([]);
    const [currentQIndex, setCurrentQIndex] = useState(0);
    const [sliderValue, setSliderValue] = useState(0); // Stores the actual percentage
    const [feedback, setFeedback] = useState(null); // null, { isCorrect: bool, correctAns: number }
    const [score, setScore] = useState({ correct: 0, wrong: 0 });

    // Valid values for Rule of Nines: 0, 1, 9, 10, 18, 19, ..., 99, 100
    // Logic: 9*k and 9*k + 1
    const validValues = useMemo(() => {
        const values = [];
        for (let i = 0; i <= 11; i++) {
            const base = i * 9;
            if (base <= 100) values.push(base);
            if (base + 1 <= 100) values.push(base + 1);
        }
        // Deduplicate and sort (though the loop naturally produces sorted distinct except at boundaries if any logic was different)
        return [...new Set(values)].sort((a, b) => a - b);
    }, []);

    // Get the index in validValues for the current sliderValue
    const currentSliderIndex = validValues.indexOf(sliderValue) !== -1 ? validValues.indexOf(sliderValue) : 0;

    // Question Generator
    const generateQuestions = () => {
        const newQuestions = [];
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            const parts = initialPartsData.map(p => ({
                ...p,
                status: Math.random() > 0.4 ? Math.floor(Math.random() * 3) + 1 : 0
            }));

            if (parts.every(p => p.status === 0)) {
                parts[Math.floor(Math.random() * parts.length)].status = Math.floor(Math.random() * 3) + 1;
            }

            let yellow = 0, orange = 0, red = 0;
            parts.forEach(p => {
                if (p.status === 1) yellow += p.percent;
                if (p.status === 2) orange += p.percent;
                if (p.status === 3) red += p.percent;
            });

            const possibleTypes = [];
            const total = yellow + orange + red;
            const secondPlus = orange + red;
            
            if (total > 0) possibleTypes.push({ type: 'level1_plus', text: '請問「一級以上」燒燙傷範圍佔總體表面積多少%？', answer: total });
            if (secondPlus > 0) possibleTypes.push({ type: 'level2_plus', text: '請問「二級以上」燒燙傷範圍佔總體表面積多少%？', answer: secondPlus });

            if (possibleTypes.length === 0) {
                 parts[0].status = 1; 
                 possibleTypes.push({ type: 'level1_plus', text: '請問「一級以上」燒燙傷範圍佔總體表面積多少%？', answer: 9 });
            }

            const selectedQ = possibleTypes[Math.floor(Math.random() * possibleTypes.length)];

            newQuestions.push({
                id: i,
                parts: parts,
                text: selectedQ.text,
                answer: selectedQ.answer
            });
        }
        setQuestions(newQuestions);
    };

    const startGame = () => {
        generateQuestions();
        setScore({ correct: 0, wrong: 0 });
        setCurrentQIndex(0);
        setSliderValue(0);
        setFeedback(null);
        setGameState('playing');
    };

    const handleSubmit = () => {
        const currentQ = questions[currentQIndex];
        const isCorrect = sliderValue === currentQ.answer;
        
        setFeedback({
            isCorrect: isCorrect,
            correctAns: currentQ.answer
        });

        if (isCorrect) {
            setScore(prev => ({ ...prev, correct: prev.correct + 1 }));
        } else {
            setScore(prev => ({ ...prev, wrong: prev.wrong + 1 }));
        }
    };

    const nextQuestion = () => {
        if (currentQIndex < TOTAL_QUESTIONS - 1) {
            setCurrentQIndex(prev => prev + 1);
            setSliderValue(0);
            setFeedback(null);
        } else {
            setGameState('result');
        }
    };

    const handleSliderChange = (e) => {
        const index = parseInt(e.target.value, 10);
        setSliderValue(validValues[index]);
    };

    // --- Intro Screen ---
    if (gameState === 'intro') {
        return (
            <div className="h-full flex flex-col items-center justify-center bg-slate-50 p-6 text-center">
                 <div className="bg-white p-8 rounded-3xl shadow-lg max-w-xs w-full">
                    <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                        <Book size={40} className="text-blue-600" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">燒燙傷評估測驗</h2>
                    <p className="text-slate-500 mb-6 text-sm">
                        共 {TOTAL_QUESTIONS} 題。<br/>
                        觀察人體圖的燒傷顏色，拖曳滑桿回答正確的面積百分比。
                    </p>
                    <div className="space-y-3">
                         <button onClick={startGame} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-md hover:bg-blue-700 hover:shadow-lg transition-all flex items-center justify-center gap-2">
                            <Play size={20} fill="currentColor" /> 開始測驗
                        </button>
                        <button onClick={() => setView('home')} className="w-full py-3 bg-white text-slate-600 border border-slate-200 rounded-xl font-medium hover:bg-slate-50 transition-colors">
                            回主選單
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // --- Result Screen ---
    if (gameState === 'result') {
        const percentage = Math.round((score.correct / TOTAL_QUESTIONS) * 100);
        let message = "";
        if (percentage === 100) message = "太神啦！完美急救專家！";
        else if (percentage >= 80) message = "非常優秀！觀念很正確！";
        else if (percentage >= 60) message = "及格了，但還可以更好！";
        else message = "加油，多練習幾次九分法！";

        return (
             <div className="h-full flex flex-col items-center justify-center bg-slate-50 p-6 text-center">
                 <div className="bg-white p-8 rounded-3xl shadow-xl max-w-xs w-full animate-[fadeInUp_0.5s_ease-out]">
                    <div className="bg-yellow-100 p-4 rounded-full inline-block mb-4">
                        <Trophy size={48} className="text-yellow-600" />
                    </div>
                    <h2 className="text-3xl font-black text-slate-800 mb-1">{percentage}%</h2>
                    <p className="text-slate-500 font-medium mb-6">{message}</p>
                    
                    <div className="flex justify-center gap-8 mb-8 text-sm">
                        <div className="flex flex-col items-center">
                            <span className="text-green-500 font-bold text-xl">{score.correct}</span>
                            <span className="text-slate-400">答對</span>
                        </div>
                        <div className="flex flex-col items-center">
                            <span className="text-red-500 font-bold text-xl">{score.wrong}</span>
                            <span className="text-slate-400">答錯</span>
                        </div>
                    </div>

                    <div className="space-y-3">
                         <button onClick={startGame} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-md hover:bg-slate-700 transition-all flex items-center justify-center gap-2">
                            <RotateCcw size={18} /> 再測驗一次
                        </button>
                        <button onClick={() => setView('home')} className="w-full py-3 bg-white text-slate-600 border border-slate-200 rounded-xl font-medium hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                            <Home size={18} /> 回主畫面
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // --- Playing Screen ---
    const currentQ = questions[currentQIndex];

    return (
        <div className="h-full flex flex-col bg-slate-50">
            {/* Header */}
            <div className="bg-white px-4 py-3 shadow-sm flex items-center justify-between shrink-0">
                <button onClick={() => setGameState('intro')} className="text-slate-400 hover:text-slate-600">
                    <XCircle size={24} />
                </button>
                <div className="font-bold text-lg text-slate-700">
                    第 <span className="text-blue-600 text-xl">{currentQIndex + 1}</span> / {TOTAL_QUESTIONS} 題
                </div>
                <div className="w-6"></div> {/* Spacer */}
            </div>

            {/* Body Diagram Area */}
            <div className="flex-1 relative bg-white">
                <BodyDiagram parts={currentQ.parts} readOnly={true} />
            </div>

            {/* Interaction Area */}
            <div className="bg-white border-t border-slate-100 p-5 shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-2xl">
                {!feedback ? (
                    <>
                        <h3 className="font-bold text-slate-800 mb-4 text-lg leading-tight">
                            {currentQ.text}
                        </h3>
                        
                        {/* Slider */}
                        <div className="mb-6 px-2">
                            <div className="flex justify-between text-xs text-slate-400 font-bold mb-2">
                                <span>0%</span>
                                <span className="text-blue-600 text-2xl animate-[pulse_0.5s_ease-in-out]">{sliderValue}%</span>
                                <span>100%</span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max={validValues.length - 1} // Step index
                                value={currentSliderIndex} 
                                onChange={handleSliderChange}
                                className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
                            />
                            <div className="text-center text-[10px] text-slate-400 mt-1">
                                提示：數值會依照九分法規則跳動
                            </div>
                        </div>

                        <button 
                            onClick={handleSubmit}
                            className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-slate-700 active:scale-[0.98] transition-all"
                        >
                            回答
                        </button>
                    </>
                ) : (
                    <div className="text-center py-2 animate-[fadeIn_0.3s_ease-out]">
                        <div className="mb-4">
                            {feedback.isCorrect ? (
                                <div className="flex flex-col items-center text-green-500">
                                    <CheckCircle size={48} className="mb-2" />
                                    <span className="font-black text-2xl">回答正確！</span>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center text-red-500">
                                    <XCircle size={48} className="mb-2" />
                                    <span className="font-black text-2xl">回答錯誤</span>
                                </div>
                            )}
                            <div className="mt-2 text-slate-600">
                                正確答案是 <span className="font-bold text-xl">{feedback.correctAns}%</span>
                            </div>
                        </div>
                        <button 
                            onClick={nextQuestion}
                            className={`w-full py-3 rounded-xl font-bold text-lg shadow-lg transition-all text-white ${feedback.isCorrect ? 'bg-green-500 hover:bg-green-600' : 'bg-slate-800 hover:bg-slate-700'}`}
                        >
                            {currentQIndex < TOTAL_QUESTIONS - 1 ? '下一題' : '查看結果'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- Rule of Nines View ---
const RuleOfNinesView = ({ setView }) => {
  const [parts, setParts] = useState(initialPartsData);
  const [lastAction, setLastAction] = useState({ name: '請點擊部位', percent: 0, status: 0 });

  const toggleStatus = (id) => {
    let clickedPart = null;
    const newParts = parts.map(part => {
      if (part.id === id) {
        const nextStatus = (part.status + 1) % 4;
        clickedPart = { ..
